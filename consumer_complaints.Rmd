---
title: "Investigating the Qualities of Business Services Using Consumer Complaints"
author: "Huong (Ivy) Nguyen"
date: "April 23, 2017"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=TRUE, message=FALSE)

options(scpien = 9999)

#load the dataset
df = read.csv("Consumer_Complaints.csv")

#Remove na values from the dataframe
df <- na.omit(df)

west = c('WA','OR','CA','ID','NV','MT','WY','UT','AZ','CO','NM', 'AK', 'HI')
south = c('TX','OK','AR','LA','MS','AL','TN','KY','WV','VA','NC','MD','DE','SC','GA','FL')
midwest = c('ND','SD','NE','KS','IA','MO','MN','WI','IL','MI','IN','OH')
northeast = c('PA','NY','NJ','CT','RI','MA','VT','NH','ME')
valid_state <- c(west, south, midwest, northeast)


#Remove rows with invalid states
df <- subset(df, df$State %in% valid_state)
```


##**INTRODUCTION*

This project involves investigating and evaluating the quality of business services from different categories across the United States based on the [Consumer Compalaint Database](https://catalog.data.gov/dataset/consumer-complaint-database#topic=consumer_navigation) collected by the Consumer Financial Protection Bureau (CFPB). The main goal of this project is to use the provided database to point out the quality of business services offered to customers based on the complaints filed. In addition, this data analysis could potentially help businesses compare their customer services or customer satisfactory versus their competitors. Through this comparison, businesses can improve the employee training or develop a new strategy for their business plan to make more profit.   

##**DATA EXPLORATORY SECTION**##

### Data Structure

```{r}
#Get a summary of the data
summary(df)

#Obtain details of each variable
str(df)

#View couple lines of the dataframe to see how the data looks like
head(df)
```

This dataset contains 762444 observations (rows) and 18 different variables. After looking through the dataset, I want to know how many products are present within this database. 

```{r}
###Load necessary packages for data exploration and analysis###
require(ggplot2)
require(grid)
require(scales)
require(dplyr)
require(gridExtra)
library(RColorBrewer)
library(ggthemes)
```

```{r}
print(paste("There are", length(unique(df$Product)), "different business services in this dataset."))
```

First, I want to count the number of complaints for each different business service. In order to accomplish this, I will have to create a new dataframe, which has the sum of count of complaints for each product based on the state. 

```{r}
complaints_by_product <- df %>%
  group_by(Product, State) %>%
  summarize(complaints_sum = length(Complaint.ID))
```

After investigating this new dataframe, I noticed that there are 12 rows without a state being specified for each product category. These 12 rows are stored in the new_complaints_by_products dataframe. My initial suspection is that these rows are the average of the number of complaints for each service. Let's check out if this assumption is correct.

```{r}
new_complaints_by_product <- complaints_by_product[complaints_by_product$State == '',]

complaints_by_product_check <- filter(complaints_by_product, State=='') %>%
  group_by(Product)%>%
  summarize(sum_count = mean(complaints_sum))
```

After checking, the two dataframes: complaints_by_product and new_complaints_by_product look exactly the same. Therefore, I decided to drop these rows out of my complaint_by_product dataset since it would be redundant to keep them. In addition, I would like to get an average number of complaints across all the states to see which product has the most complaints in the U.S.

```{r}
complaints_sum <- complaints_by_product[complaints_by_product$State != '',]%>%
  group_by(Product) %>%
  summarize(complaints_sum = sum(complaints_sum))

ggplot(data = complaints_sum, aes(x=Product, y=complaints_sum, fill=Product))+
  geom_bar(stat = 'Identity',
           position = 'dodge')+
  ggtitle("The average number of complaints by product across all states in the U.S.")+
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=.4))
```

Mortgage has the highest number of complaints of all categories, which makes me more curious to investigate further into differnt sub-product of this product/service to see which service has the most number of complaints and whether these complaints are resolved. However, before jumping to this set of investigation. I would like to group the number of complaints for each product based on different regions within the U.S. to see whether there is a distribution regarding the quality of these business services. 

```{r}
complaints_by_product <- complaints_by_product[complaints_by_product$State != '',]

#Initialize region column with all NAs 
complaints_by_product$region <- NA

complaints_by_product$region[complaints_by_product$State %in% west] <-'West'
complaints_by_product$region[complaints_by_product$State %in% south] <-'South'
complaints_by_product$region[complaints_by_product$State %in% midwest] <-'Midwest'
complaints_by_product$region[complaints_by_product$State %in% northeast] <-'Northeast'
```

After assign the region for each row, I also noticed that there are several rows that cannot be assigned due to the wrong state abbreviation. Since it is impossible to identify which state these rows belong to, I decided to remove them from my data analysis. 

```{r}
#Remove na values 
complaints_by_product <- na.omit(complaints_by_product)

#Calculate sum of complaints based on product and region
complaints_by_region <- complaints_by_product %>%
  group_by(region, Product)%>%
  summarize(complaints_sum = sum(complaints_sum))

#Generate plot for regions
ggplot(data=complaints_by_region, 
       aes(x=Product, y=complaints_sum, 
           fill=region))+
  geom_bar(stat = 'Identity',
           position='dodge', 
           aes(color=region))+
  ggtitle("Total complaints of each product based on region")+
  theme(axis.text.x=element_text(angle = 90, 
                                 hjust = 1, 
                                 vjust = 0.4))

ggplot(data=complaints_by_region, 
       aes(x=region, y=complaints_sum, 
           fill=region))+
  geom_bar(stat = 'Identity',
           position='dodge')+
  facet_wrap(~Product)
  ggtitle("Total complaints of each product based on region")
```

The South region has the highest number of complaints in all product categories. The next region with the second highest number of complaints is the West coast.

#### Mortgage Zone: Digging Deeper

Since the mortgage-type product has the most number of complaints filed, I would like to see which company has the largest number of complaints, and within those complaints, how many of them are resolved complaints in a timely manner. 

```{r}
#Subset mortgage-type product
mortgage_complaints <- subset(df, df$Product == 'Mortgage'& df$State != '')

#Getting the list of companies who offer mortgage services 
mortgage_comp <- unique(mortgage_complaints$Company)
print(paste("There are", length(mortgage_comp), "different companies which offer mortgage services"))

#obtain a list of top 10 mortgage companies that have the largest number of complaints 
#based on state
top_20_mortgage <- mortgage_complaints %>%
   group_by(Company) %>%
   summarize(complaints_sum = sum(Complaint.ID))%>%
   arrange(desc(complaints_sum))%>%
   top_n(20)

ggplot(data=top_20_mortgage, 
       aes(x=Company, y=complaints_sum), 
       color=Company) +
   geom_bar(stat = 'Identity', position='dodge', horiz = TRUE) +
   ggtitle("Top 20 Companies with the Highest Number of Complaints") +
   coord_flip()
```

Next, I want to see whithin these top 20 companies with the highest number of complaints, how many of those complaints are resolved in a timely manner. 

```{r}
timely_resposes <- filter(mortgage_complaints, 
                          Company %in% top_20_mortgage[['Company']]) %>%
   group_by(Company) %>%
   summarize(on_time = nrow(subset(mortgage_complaints,
                                   Timely.response. == 'Yes')), 
             late = nrow(subset(mortgage_complaints, 
                                Timely.response. == 'No'))) %>%
   mutate(on_time_percentage = round(100*on_time/(on_time+late),2),
          delay_percentage = round(100*late/(on_time+late),2)) %>%
   arrange(desc(delay_percentage))

p1 <- ggplot(data = timely_resposes, aes(x=Company, y=on_time_percentage))+
   geom_bar(stat='identity')+
   theme(axis.text.x = element_text(angle=90))+
   coord_flip()

p2 <- ggplot(data = timely_resposes, aes(x=Company, y=delay_percentage))+
   geom_bar(stat = "identity")+
   theme(axis.text.x = element_text(angle=90))+
   coord_flip()

grid.arrange(p1, p2, nrow=2)
```

Residential Credit Solutions has the largest percentage in term of delaying to respond to their customers with 21% delayed responses out of the total number of complaints that they have received. CIT Bank National Association has the second largest delay percentage in delayed response, ~6.13%, which is significantly less than Residential Credit Solutions. The other companies in this list have a 4% or less in term of delayed responses, which is tolerable for a large-sized compnay in my opinion. 

This finding makes me more curious in investigate the customer service that Residential Credit Solutions in all types of products that they offer. 

#### Maping number of complaints by state

```{r}
library(choroplethr)
library(choroplethrMaps)
library(choroplethrZip)

complaints_by_state <- df %>%
  group_by(State)%>%
  summarize(complaints_sum = nrow(Complaint.ID))
